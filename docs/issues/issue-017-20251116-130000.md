# Issue #017: Duplicate Answer Options in Challenge Mode

**Date**: 2025-11-16 13:00:00  
**Status**: Resolved  
**Priority**: High  
**Reported By**: User  
**Assigned To**: AI Assistant  
**Resolved**: 2025-11-16 13:30:00

## Problem Description

User reported: "there are clones of the same answer in the challenge mode"

Multiple choice options showing duplicate values, e.g., same slope appearing twice in the answer choices.

## Root Cause Analysis

**ISSUE LOCATION**: `generateSlopeQuestion()` lines 758-763

The problem occurs when assembling options:
```javascript
const slopeOptions = [
    { value: slopeValue, correct: true },
    { value: slopeDistractors[0], correct: false },
    { value: slopeDistractors[1], correct: false },
    { value: slopeDistractors[2], correct: false }
].sort(() => Math.random() - 0.5);
```

**ROOT CAUSES**:
1. **No final deduplication**: Even though `generateSlopeDistractors()` tries to avoid duplicates, if a distractor happens to match the correct answer (due to floating point issues, string formatting, or logic errors), it still gets added
2. **String comparison issues**: `formatSlopeValue()` might format the same numeric value differently in different contexts
3. **No validation**: No check ensures all 4 options are unique before displaying

**EXAMPLE SCENARIO**:
- Correct answer: "-1"
- Distractor generation produces: ["-1", "1", "0"]  (accidentally includes "-1")
- Final options: ["-1", "-1", "1", "0"]  â†’ Duplicate!

## Solution

Add explicit deduplication and fallback logic:

1. **Deduplicate options** after creating the array
2. **Backfill with fallback values** if deduplication reduces options below 4
3. **Validate** that we always have exactly 4 unique options

```javascript
// Create options with deduplication
let slopeOptions = [
    { value: slopeValue, correct: true },
    ...slopeDistractors.map(d => ({ value: d, correct: false }))
];

// Deduplicate by value
const seen = new Set();
slopeOptions = slopeOptions.filter(opt => {
    if (seen.has(opt.value)) {
        return false; // Duplicate, filter out
    }
    seen.add(opt.value);
    return true;
});

// If we have less than 4 options due to duplicates, add fallback values
const simpleValues = [0, 1, -1, 2, -2, 3, -3, '1/2', '-1/2', '1/3', '-1/3', '2/3', '-2/3', '3/2', '-3/2', 'undefined'];
for (const val of simpleValues) {
    if (slopeOptions.length >= 4) break;
    if (!seen.has(val.toString())) {
        slopeOptions.push({ value: val.toString(), correct: false });
        seen.add(val.toString());
    }
}

// Shuffle
slopeOptions.sort(() => Math.random() - 0.5);
```

## Testing Plan

1. Generate 100 slope questions
2. Verify each has exactly 4 unique options
3. Verify correct answer appears exactly once
4. Check all slope types (vertical, horizontal, positive, negative, fractional)

## Acceptance Criteria

- [x] Root cause identified
- [x] Fix implemented with deduplication
- [x] All question types checked (slope, classification, relationship, parallel, perpendicular)
- [x] Helper function created for reusable deduplication
- [x] Fallback values added for each question type
- [x] Code builds without errors
- [x] Issue documented
- [x] Code deployed
- [ ] Manual testing passed (user to verify)
- [ ] No duplicate options in any mode confirmed

## Related Issues

- Issue #015: Complex fractions fix
- Issue #016: Auto-advance not working
- Milestone 15: Fraction-Only Answer Format

## Notes

This issue affects all multiple choice question types. Need to apply the same deduplication pattern to:
- Slope questions
- Relationship questions  
- Parallel/Perpendicular questions
- All other question types

